================================================================================

Author intent:
- Build a Svelte-native editor core (TS) + renderer + UI.
- Keep the "engine" framework-agnostic so Web + Tauri share it.
- Defer collaboration until single-player is correct.

Conventions:
- [ ] Task
- (DoD) Definition of Done for the milestone
- Files shown are ideas, not requirements

================================================================================
1. Milestone A: Repo skeleton + dev loop                                  *wb-A*
================================================================================

Created a project monorepo/workspace.

================================================================================
2. Milestone B: Math + coordinate systems                                 *wb-B*
================================================================================

Camera math, matrix utilities, and transforms are fully implemented and verified
so world and screen coordinates map precisely.

================================================================================
3. Milestone C: Document model (records)                                  *wb-C*
================================================================================

Document/page/shape/binding records plus validation let the editor serialize and
reason about drawings safely.

================================================================================
4. Milestone D: Store + selectors (reactive core)                         *wb-D*
================================================================================

The reactive store, invariants, and selectors supply deterministic state streams
for both renderer and UI subscribers.

================================================================================
5. Milestone E: Canvas renderer (read-only)                               *wb-E*
================================================================================

The renderer now draws the document via Canvas2D with camera transforms,
DPI scaling, text sizing, and selection outlines.

================================================================================
6. Milestone F: Hit testing (picking)                                     *wb-F*
================================================================================

Geometry helpers compute bounds and intersections so hit testing can always
return the topmost shape under the cursor.

================================================================================
7. Milestone G: Input system (pointer + keyboard)                         *wb-G*
================================================================================

Pointer and keyboard adapters now normalize events, map them into actions, and
feed the editor consistently across platforms.

================================================================================
8. Milestone H: Tool state machine (foundation)                           *wb-H*
================================================================================

Tool interfaces and the router manage lifecycle hooks so each tool is an
explicit, testable state machine.


================================================================================
9. Milestone I: Select/move tool (MVP interaction)                        *wb-I*
================================================================================

Selection logic handles hit selection, marquee, dragging, deletion, and escape
so shapes can be moved reliably.

================================================================================
10. Milestone J: Create basic shapes via tools                            *wb-J*
================================================================================

Rect, ellipse, line, arrow, and text tools now create shapes via click-drag
interactions with proper finalize/cancel behavior.

================================================================================
11. Milestone K: Bindings for arrows (v0)                                 *wb-K*
================================================================================

Arrow endpoints bind to target shapes and stay attached by recalculating anchors
whenever shapes move.

================================================================================
12. Milestone L: History (undo/redo)                                      *wb-L*
================================================================================

All document-affecting actions run through undoable commands with history stacks
and keyboard shortcuts.

================================================================================
13. Milestone M: Persistence (web) via Dexie + History integration        *wb-M*
================================================================================

Document changes now persist to IndexedDB via Dexie with migrations, repo API,
and history-driven syncing.

================================================================================
14. Milestone N: Status Bar (Editor HUD)                                  *wb-N*
================================================================================

The HUD is now powered end-to-end via a `StatusBarVM` + cursor store, a web
persistence/snap manager, and `StatusBar.svelte` with snap/grid toggles backed
by unit/integration tests for selectors, cursor throttling, persistence
transitions, and Canvas wiring.

Note: Zoom controls were moved to Toolbar in Milestone O for better UX.

================================================================================
15. Milestone O: Export (PNG/SVG)                                         *wb-O*
================================================================================

PNG/SVG export flows now deliver one-click viewport or selection exports from
the Toolbar across web and desktop builds.

================================================================================
16. Milestone P: Desktop packaging (Tauri)                                *wb-P*
================================================================================

Goal: same app works as a desktop app with filesystem access.

Tauri + SvelteKit integration:
[x] Configure SvelteKit for static/SPA output
[x] Ensure SSR is disabled for desktop build
[x] Configure Tauri to load the built assets

File dialogs + FS:
[x] Implement "Save As…" using Tauri dialog + fs APIs
[x] Implement "Open…" using Tauri dialog + fs APIs
[x] Add recent files list (v0: store paths in Tauri local storage)

(DoD):
- Desktop app opens/saves JSON files on disk and reopens them correctly.

================================================================================
17. Milestone Q: Performance + big docs (pragmatic)                       *wb-Q*
================================================================================

Goal: the editor stays responsive with many shapes.

[ ] Add spatial index (v0: simple grid buckets):
    - rebuild index on doc changes
    - query nearby shapes for hit testing
[ ] Add view culling:
    - compute viewport bounds in world space
    - render only shapes whose bounds intersect viewport
[ ] Reduce redraw frequency:
    - rAF only while dirty
    - optionally batch multiple store updates into one redraw
[ ] Add microbench harness:
    - generate 10k shapes doc
    - measure hit test and render time

(DoD):
- 10k simple shapes pans/zooms smoothly on a typical machine.

================================================================================
18. Milestone R: File Browser (web: Dexie inspector, desktop: FS)         *wb-R*
================================================================================

Goal: A unified "Open board" experience:
- Web: browse Dexie-backed boards + a useful persistence/migration inspector
- Desktop: browse real directories/files (native file browser semantics)

--------------------------------------------------------------------------------
R1. Shared UX contracts
--------------------------------------------------------------------------------

/packages/core/src/persist/DocRepo.ts:
[x] Define DocRepo interface (web + desktop):
    - listBoards(): Promise<BoardMeta[]>
    - createBoard(name): Promise<string>
    - openBoard(id): Promise<void>
    - renameBoard(id, name): Promise<void>
    - deleteBoard(id): Promise<void>

[x] Define FileBrowserViewModel:
    - query, filteredBoards, selectedId
    - actions: open/create/rename/delete

(DoD):
- Svelte UI can render the browser purely from the ViewModel.

--------------------------------------------------------------------------------
R2. Web: Boards list + Dexie "Inspector" drawer
--------------------------------------------------------------------------------

/apps/web/src/lib/filebrowser/FileBrowser.svelte:
[x] Boards panel:
    - listBoards() -> render
    - search filter
    - open / create / rename / delete

Inspector drawer (selected board):
[x] Show "Storage"
[x] Show schema info:
    - declared schema version
    - installed schema version
[x] Show board-level stats (computed live):
    - row counts: pages/shapes/bindings for this board & doc size bytes for docs row
    - last updatedAt
[x] Show migration info:
    - list applied migrations from migrations table (id + appliedAt)
    - show "pending" migrations if any (based on known list vs applied)

Safe deletes:
[x] deleteBoard must be a single atomic transaction (boards + related tables)

(DoD):
- Web: you can browse boards, open one, and verify migrations + row counts.

--------------------------------------------------------------------------------
R3. Desktop: real directory + files (Tauri)
--------------------------------------------------------------------------------

[x] Add "Workspace folder" concept:
    - pick directory
    - remember last workspace path
[x] Implement directory listing:
    - show *.inkfinite.json files in workspace
    - tree view with folders
[x] Implement file actions:
    - [x] New: create new file
    - [x] Rename: rename file (Tauri command needed)
    - [x] Delete: delete file (Tauri command needed)
    - [x] Open: load file into editor
    - [x] Export: save JSON

(DoD):
- Desktop: pick a folder, browse files, open/save boards from disk.

--------------------------------------------------------------------------------
R4. Parity behaviors
--------------------------------------------------------------------------------

[x] Same shortcuts:
    - Ctrl/Cmd+O opens file browser
    - Ctrl/Cmd+N creates board
[x] Consistent metadata display:
    - name + updatedAt in both modes

(DoD):
- Web and desktop feel like the same app, with storage differences made explicit

================================================================================
19. Milestone S: Quality polish.                                          *wb-S*
================================================================================

Comprehensive UX polish adds BEM CSS, space-drag panning, richer keyboard
affordances, improved accessibility and styling, refined snapping, and handles
so drawing feels production-ready.

================================================================================
20. Milestone T: Sketching / Pen Tool (perfect-freehand)                  *wb-T*
================================================================================

Goal:
Add a pen tool that produces smooth freehand strokes using perfect-freehand.
Strokes are shapes, undo/redo-able (L), persisted (M), selectable, and render on
Canvas2D.

Refs:
- perfect-freehand getStroke returns outline polygon points.
- Options: size/thinning/smoothing/streamline/simulatePressure.

------------------------------------------------------------------------------
T1. Data model: Stroke shape
------------------------------------------------------------------------------

/packages/core/src/model:
[ ] Add ShapeType: 'stroke'
[ ] StrokeShape props (persisted):
    - points: Array<[x,y,p?]>          " world coords + optional pressure
    - style: { color, opacity }
    - brush: { size, thinning, smoothing, streamline, simulatePressure }
[ ] Derived (NOT persisted):
    - outline?: Array<[x,y]>           " computed polygon
    - bounds?: Box2

(DoD): stroke serializes to JSON and loads back identically.

------------------------------------------------------------------------------
T2. Tool: pen (state machine)
------------------------------------------------------------------------------

/packages/core/src/tools.ts (PenTool)
[ ] PointerDown: start draft, push first point
[ ] PointerMove: append point if moved > eps; include pressure if available
[ ] PointerUp: create ONE history command that inserts the stroke; clear draft

Perf:
[ ] Coalesce draft updates (rAF) so you don’t recompute per event.

(DoD): one stroke == one undo step; no DB writes until finalize (via M).

------------------------------------------------------------------------------
T3. Geometry: compute outline via perfect-freehand
------------------------------------------------------------------------------

/packages/core/src/geom.ts:
[ ] computeOutline(points, brush) -> outlinePoints using getStroke()
[ ] boundsFromOutline(outline) -> Box2

(DoD): outline non-empty for >= 2 points; bounds contain outline.

------------------------------------------------------------------------------
T4. Rendering: fill the outline polygon
------------------------------------------------------------------------------

/packages/renderer/src/draw.ts:
[ ] drawStroke(ctx, stroke):
    - outline = cached || computeOutline(...)
    - ctx.beginPath(); moveTo/lineTo...; closePath(); fill()
[ ] Render draft stroke above shapes, below selection UI.

(DoD): strokes look stable while drawing; committed strokes match preview.

------------------------------------------------------------------------------
T5. Hit testing
------------------------------------------------------------------------------

/packages/core/src/geom.ts:
[ ] hitTestStroke(p, stroke):
    - bounds check first
    - inside-outline polygon test (ray cast) (or tolerance-to-segment fallback)

(DoD): clicking a stroke selects it reliably.

------------------------------------------------------------------------------
T6. Brush settings (thin UI slice)
------------------------------------------------------------------------------

/apps/web/src/lib/components/BrushPopover.svelte:
[ ] Sliders: size, thinning, smoothing, streamline
[ ] Toggle: simulatePressure
(All map to perfect-freehand options.)

(DoD): settings affect newly drawn strokes immediately.

------------------------------------------------------------------------------
T7. Tests
------------------------------------------------------------------------------

/packages/core/test/pen.test.ts:
[ ] outline computed for a simple polyline
[ ] bounds correctness
[ ] hit test inside/outside sanity

Integration:
[ ] one history command per stroke; undo/redo persists through refresh (M).

------------------------------------------------------------------------------
Definition of Done
------------------------------------------------------------------------------

- Pen tool draws smooth strokes using perfect-freehand outlines.
- Strokes are selectable, undo/redo-able in one step, and persisted via Dexie.
- Brush controls change appearance of new strokes.

================================================================================
References (URLs)                                                      *wb-refs*
================================================================================

tldraw conceptual references (inspiration only):
- https://tldraw.dev/docs/shapes
- https://tldraw.dev/docs/editor
- https://tldraw.dev/reference/editor/Editor

SvelteKit + Tauri packaging:
- https://v2.tauri.app/start/frontend/sveltekit/
- https://svelte.dev/docs/kit/adapter-static
- https://tauri.app/v1/guides/getting-started/setup/sveltekit/

Canvas/infinite-canvas performance ideas:
- https://antv.vision/infinite-canvas-tutorial/guide/lesson-008
- https://harrisonmilbradt.com/blog/canvas-panning-and-zooming

Perfect Freehand
- https://github.com/steveruizok/perfect-freehand
- (Options) https://github.com/steveruizok/perfect-freehand/blob/main/packages/perfect-freehand/src/types.ts
