================================================================================
- Build a Svelte-native editor core (TS) + renderer + UI.
- Keep the "engine" framework-agnostic so Web + Tauri share it.
- Defer collaboration until single-player is correct.

Conventions:
- [ ] Task
- (DoD) Definition of Done for the milestone
- Files shown are ideas, not requirements

================================================================================
Milestone P: Performance                                                  *wb-P*
================================================================================

Goal: the editor stays responsive with many shapes.

[ ] Add spatial index:
    - rebuild index on doc changes
    - query nearby shapes for hit testing
[ ] Add view culling:
    - compute viewport bounds in world space
    - render only shapes whose bounds intersect viewport
[ ] Reduce redraw frequency:
    - rAF only while dirty
    - optionally batch multiple store updates into one redraw
[ ] Add microbench harness:
    - generate 10k shapes doc
    - measure hit test and render time

(DoD):
- 10k simple shapes pans/zooms smoothly on a typical machine.

================================================================================
Milestone L: Layers                                                       *wb-L*
================================================================================

Goal:
Add real layers: reorder, hide/show, lock, and per-layer opacity. This is now a
baseline expectation even for "simple" editors.

--------------------------------------------------------------------------------
L1. Data model (doc)
--------------------------------------------------------------------------------

/packages/core/src/model:
[ ] Add LayerRecord:
    - id, boardId/pageId
    - name
    - order: number (or layerIds array on page)
    - visible: boolean
    - locked: boolean
    - opacity: number (0..1)

[ ] Attach shapes to layers:
    - ShapeRecord.layerId: string
    - Default layer created on new board/page

(DoD): Old docs migrate to "single default layer" automatically (Dexie
       migration).

--------------------------------------------------------------------------------
L2. Rendering order + behavior
--------------------------------------------------------------------------------

/packages/renderer-canvas2d:
[ ] Render layers in order:
    - skip invisible
    - apply opacity per layer (ctx.globalAlpha)
[ ] Selection rendering respects visibility:
    - do not show selection UI for hidden shapes

(DoD): Hiding a layer truly removes it from view and interaction.

--------------------------------------------------------------------------------
L3. Interaction rules
--------------------------------------------------------------------------------

[ ] Locked layer:
    - shapes cannot be selected or edited
    - marquee ignores locked shapes
[ ] Active layer:
    - new shapes are created into the active layer
[ ] Reorder layers:
    - drag to reorder, updates draw order

(DoD): Lock/hide behave exactly as users expect.

--------------------------------------------------------------------------------
L4. UI panel
--------------------------------------------------------------------------------

/apps/web:
[ ] Layers panel:
    - list layers with eye + lock toggles
    - rename layer
    - new/delete layer
    - drag reorder
    - set active layer
    - opacity slider per layer (optional v0, recommended v1)

(DoD): Layers are discoverable and usable without shortcuts.

--------------------------------------------------------------------------------
L5. Persistence + migrations
--------------------------------------------------------------------------------

[ ] Dexie migration:
    - add layers table and layerId field on shapes (if normalized)
    - backfill existing shapes -> default layer
    - ensure boards/pages have at least 1 layer

(DoD): Existing boards load unchanged but now sit on a default layer.

--------------------------------------------------------------------------------
L6. Tests
--------------------------------------------------------------------------------

[ ] Hidden layer shapes not hit-testable
[ ] Locked layer shapes not editable
[ ] New shape inherits active layer
[ ] Migration backfills correctly

(DoD): No regressions in selection/marquee/editing across layers.

================================================================================
Milestone S: Stencils (built-in)                                          *wb-S*
================================================================================

Goal:
Ship a curated set of built-in stencils (flowchart + UI + dev diagrams) with a
pleasant insertion workflow. No sharing/community libraries yetâ€”just "your own".

--------------------------------------------------------------------------------
S2. Insert UX
--------------------------------------------------------------------------------

/apps/web:
[ ] Placement rules:
    - insert into active layer (when layers are added)
    - [x] snap to grid if enabled

(DoD): Inserting stencils is faster than drawing shapes manually.

================================================================================
Parking Lot                                                              *wb-pl*
================================================================================

- [ ] Opacity for shapes
    - expose fill/stroke opacity controls so translucent layering is possible
      without exporting.
- [ ] Markdown layout caching
    - cache layout per (md, w, style) to avoid re-parsing on every render
- [ ] Bug Fix: Cursor Mapping
    - Investigate cursor position getting stuck or offsetting after window resize.
